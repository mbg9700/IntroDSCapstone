---
Title: "Classifying deaths in Washington State by homelessness status"
author: Maya Bhat-Gregerson
output: github_document
---

```{r echo=FALSE}

library(knitr)
library(here)
library(dplyr)
library(readr)
library(data.table)
library(tidyr)
library(naniar)

opts_chunk$set(message = FALSE, error=FALSE)
```


## I. Overview

The purpose of this project is to create a machine learning model that will classify deaths in Washington State according to the residential status of decedents at the time of death i.e. with permanent housing vs. homeless.

The datasets used for this project include Washington State final annual death files 2003-2017(including records for all deaths occurring within Washington State in a given calendar year) and the King County Medical Examiner Office`s registry of deaths among homeless individuals who died in King County, Washington.  This registry contains identification information and place of death for homeless individuals who died between 2003 through late 2017.


## II. Data pre-processing

### A. Overview

####    1. Data cleaning and standardization

I will prepare the data sets will in the following order:

  a. Limit Washington mortality data sets (WAMD) to attributes that are likely to be relevant to training the machine learning model. 
  
  b. Standardize attribute names and formats in both WAMD and King County Homeless Death Registry (HDR) data. Due to changes in data collection practices for WAMD over the years, attribute names and formats are inconsistent.
  
  c. Limit records in WAMD to decedents who were Washington State residents who died in Washington State.

####    2. Linking homeless death data to their death certificates  

This will add the additional attributes from WAMD to each of the records in HDR so that they have the necessary attributes to train the model.

####    3. Creating a subset of WAMDR with decedents who had permanent homes

I will limit this to approximately 1,000 randomly selected records from the 2017 WAMD datafile.  I will identify decedents who had permanent homes at the time of death by the facility type (type of facility where the person died) and place of death variables.   
  
  
### B. Washington State mortality data


Washington State requires by law that all deaths occurring in the state must be registered with the Washington State Department of Health by the funeral director organizing the disposal of the body and the decedents` regular health care provider. In the absence of a health care provider the medical examiner or coroner in the county where the body was found has jurisdiction over the death. The Washington State death data set for 2017 contains over 58,000 unique observations (death records) and over 250 attributes.  Most of the attributes are not relevant to train the machine learning model for this project.

This section addresses cleaning and limiting the data sets (in terms of number of attributes).
  
1.  __Cleaning and standardizing WAMD annual data 2003-2017__

```{r}

keepvars <- c("certno" , "last_name" , "first_name" ,"middle_name" , "date_of_death" , "dob" , "ssn" , "res_street" , "res_city" , "res_zip" , "sex" , "dth_yr" , "race" , "hisp" , "city_occ" , "cnty_occ" , "facility" , "fac_type" , "married" , "city_res" , "cnty_res" , "underly" , "contrib" , "attclass" , "educ" , "zipcode", "st_res", "st_occ")

newnames <- c("certno", "lname", "fname", "mname", "dod", "dob", "ssn", "resst", "rescity", "reszip", "sex", "dthyr", "race", "hisp", "cityocc", "cntyocc", "facility", "factype", "married", "cityres", "cntyres", "underly", "contrib", "attclass", "educ", "zip", "stres", "stocc")

dth03 <- fread("H:/Mortality/Homeless/IntroDSCapstone/Data/statname2003.csv", 
               select = keepvars)
dth03_wa <- subset(dth03, st_res==48 & st_occ==48)
names(dth03_wa)=newnames

dth04 <-fread("H:/Mortality/Homeless/IntroDSCapstone/Data/statname2004.csv", 
               select = keepvars)
dth04_wa <- subset(dth04, st_res==48 & st_occ==48)
names(dth04_wa)=newnames

dth05 <-fread("H:/Mortality/Homeless/IntroDSCapstone/Data/statname2005.csv", 
               select = keepvars)
dth05_wa <- subset(dth05, st_res==48 & st_occ==48)
names(dth05_wa)=newnames

summary(dth03_wa)

###THIS PROCESS SHOULD BE REPEATED FOR EACH YEAR OF DEATH DATA THROUGH 2017. IN THE INTEREST OF TIME COMPLETED THIS IN STATA AND READ IN THE RESULTING FILES INTO R.

```



   

3.  __Creating a training data set of decedents who had permanent homes at time of death__

 Use fields:
 - `Place of Death` with values of `Hospice`, `Nursing Home/Longterm Care`, `Decedent Home`, `Hospital`
 - `Res Geo Match Score` of 100
 - `Residence Zip` is not `99999` - Check with Craig Ferguson/Brianna about this.
 - `Residence Street` does not have blanks or `homeless` or `Transient` or `&`

```{r}

dth16_King <- read_csv("H:/Mortality/Homeless/IntroDSCapstone/Data/dth16_KingCo.csv")

summary(dth16_King)
miss_var_summary(dth16_King)

permhome <- subset(dth16_King, placeofdeathtype==0 | placeofdeathtype==5 | placeofdeathtype==7 & resgeomatchscore >=95)

##RANDOMLY SELECT 1,200 persons from "PERMHOME"

set.seed(1)
sample <- sample(1:nrow(permhome), 1200)
permhome_sample <- permhome[sample, ]

str(permhome_sample)

```


### B. King County Medical Examiner`s Homeless Death Registry data - November 2003 to September 2017

This data set includes all deaths to homeless or transient individuals who died in King County, Washington State and for whom the death certifier (the person who submitted a death certificate to Washington State Department of Health) was the medical examiner for King County.

The King County Medical Examiner`s Office (KCMEO) established a given decedent`s homeless or transient status by gathering information from family members, acquaintances, social service agencies, and law enforcement (where available). In some situations, the medical examiner (ME) established homelessness based on his own assessment of the situation rather than what the family reported because the stigma associated with homelessness may have resulted in inaccurate reporting. 

KCMEO defines `homelessness` based on the Chief Medical Examiner`s criteria rather than standard federal Department of Housing and Urban Development (HUD) or Department of Social and Health Services (DSHS) criteria.  



1.  __Cleaning KCMEO homeless registry__
  
  
```{r}


homeless <- read_csv("H:/Mortality/Homeless/IntroDSCapstone/Data/HomelessRegistryKingCo.csv")


homeless <- rename(homeless, lname = namelast,
         fname = namefirst,
         mname_h = namemiddle,
         resaddr_h = resaddr,
         rescity_h = rescity,
         dob = birthdate,
         age_h = age,
         dod_h = eventdate, 
         ssn_h = ssn,
         dthzip = deathzip,
         marstat_h = maritalstatus,
         casenum_h = casenum)


##THE FOLLOWING CHANGES TO THE TWO DATE FIELDS (DATE OF BIRTH AND DATE OF DEATH) HAVE BEEN IMPLEMENTED TO MAKE
## THEM CONSISTENT WITH THE FORMAT IN THE DEATH CERTIFICATE DATA SET.  

#REMOVE HYPHENS IN DATES OF BIRTH AND DEATH TO MAKE THEM CONSISTENT WITH DEATH DATA
#DATES ARE IN DDMMMYY FORMAT TO BEGIN WITH.
homeless$dob <- gsub("-", "", homeless$dob)
homeless$dod_h <- gsub("-", "", homeless$dod_h)

#PASTE LEADING 0 TO DAY WHEN DAY IS 1 TO 9 TO MAKE THEM ALL 2 DIGIT DAYS
homeless$dob <- ifelse((nchar(homeless$dob)) < 7, paste("0",homeless$dob, sep = ""), homeless$dob)
homeless$dod_h <- ifelse((nchar(homeless$dod_h)) < 7, paste("0",homeless$dod_h, sep = ""), homeless$dod_h)

#INSERT CENTURY (19XX OR 20XX) TO YEARS TO MAKE ALL YEARS YYYY FORMAT
homeless$dob <- gsub("^([0-3][0-9][A-Z]{3})([0-9]{2})$", "\\119\\2", homeless$dob)
homeless$dod_h <- gsub("^([0-3][0-9][A-Z]{3})([0-9]{2})$", "\\120\\2", homeless$dod_h)

homeless<- mutate_all(homeless, funs(toupper))
head(homeless, 10)

```

2.  __Linking HDR with WAMD__

The HDR contains name, date of birth, date of death, place of death (address), and social security number. There is no additional information on cause of death, or other attributes that might be used in machine learning to classify persons as homeless or with a permanent home.  For this reason, the HDR data must first be linked to full death certificate data to add the relevant attributes that can be found in the death certificate.  

KCMEO is required by law to submit a death certificate for all deaths it investigates.  For this reason, it is very likely that the decedents' last names, first names, and locations of death will be recorded in an identical manner in HDR as well as the death certificates (barring data entry error).  

In this situation it is possible to use deterministic linkage to link HDR records with their complete death certificates. Using a derived attribute created by concatenating attributes in the HDR data set with low missing data ("namelast", "deathcity", "deathaddress", and "birthdate") and matching it with the same derived variable in the death data set should result in an accurate match and record linkage. 

Pre-processing of the HDR and death datasets includes standardizing the values in the attributes to be used in the linkage, and creating the derived variable (concatenation of the above variables) in both datasets. 


```{r}

## left join homeless data by year (otherwise datasets are too large) with death certificate data

## rbind all individual years of data together


```


3.  __Missing Values__

Missing values in any of the attributes in either HDR or death certificate data may be useful in the upcoming machine learning phase as it is very likely that a key distinction between decedents who were homeless vs. those who had permanent homes is that their records cannot be completed due to lack of information from family members or other "informants".


```{r}
miss_var_summary(homeless)

```





















